# M5Paper Football Scores Display - 動作仕様書

## 概要
M5Paper（ESP32搭載電子ペーパーディスプレイ）を使用したサッカー試合結果表示システムです。football-data.org APIからリアルタイムで試合データを取得し、横長レイアウトで表示します。

## ハードウェア要件
- **M5Paper** (ESP32搭載電子ペーパーディスプレイ)
- **WiFi接続** (インターネットアクセス必須)
- **電源供給** (USB-Cまたはバッテリー)

## ソフトウェア要件
### 必要なライブラリ
- `M5Unified.h` - M5Stack統合ライブラリ
- `WiFi.h` - WiFi接続用
- `HTTPClient.h` - HTTP通信用
- `ArduinoJson.h` - JSON解析用
- `time.h` - 時刻管理用

### 設定項目
```cpp
// WiFi設定
const char* ssid = "TP-Link_235C";
const char* password = "06772512";

// API設定
const char* apiKey = "da4aeda6d7b942ddbdeb727fda3059a2";

// 時刻設定
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 9 * 3600;  // JST (UTC+9)
const int daylightOffset_sec = 0;
```

## 動作仕様

### 1. 起動シーケンス
1. **初期化**
   - M5Paperの初期化
   - ディスプレイを横長モードに設定（回転90度）
   - シリアル通信開始（115200bps）

2. **WiFi接続**
   - 設定されたSSID/パスワードでWiFi接続
   - 最大30回の接続試行
   - 接続失敗時はモックデータで動作継続

3. **NTP時刻同期**
   - pool.ntp.orgから時刻取得
   - 2025年の有効な時刻のみ受け入れ
   - 同期失敗時は手動設定日付を使用

4. **初回データ取得**
   - football-data.org APIから試合データ取得
   - 取得失敗時はモックデータを使用

### 2. API通信仕様

#### 対象API
- **URL**: `https://api.football-data.org/v4/matches`
- **認証**: X-Auth-Tokenヘッダー
- **データ期間**: 2025年6月10日〜19日（10日間）
- **ステータス**: FINISHED（終了済み試合のみ）

#### リクエスト例
```
GET https://api.football-data.org/v4/matches?status=FINISHED&dateFrom=2025-06-10&dateTo=2025-06-19
Headers:
  X-Auth-Token: da4aeda6d7b942ddbdeb727fda3059a2
  User-Agent: M5Paper-Football-App/1.0
```

#### レスポンス処理
- JSON形式の試合データを解析
- 最大15試合まで保存
- 日付順（新しい順）でソート
- チーム名、スコア、大会名を抽出

### 3. ディスプレイ仕様

#### レイアウト構成
```
┌─────────────────────────────────────────────────────────────┐
│                    FOOTBALL SCORES                          │
│  [Reload]                                                   │
│  Period: 06-10 to 06-19  Status: [OK] SUCCESS (Newest First)│
│  ────────────────────────────────────────────────────────── │
│  12/01 (Sun) ★Liverpool 2-0 Man City    EPL                │
│  ────────────────────────────────────────────────────────── │
│  12/01 (Sun) =Arsenal 1-1 Fulham        EPL                │
│  ────────────────────────────────────────────────────────── │
│  12/02 (Mon) Real Madrid 2-1 ★Barcelona La Liga            │
│  ────────────────────────────────────────────────────────── │
│  ... (最大12試合表示)                                        │
│  ────────────────────────────────────────────────────────── │
│  Touch 'Reload' or press button to refresh | Time: 15:30:45 │
└─────────────────────────────────────────────────────────────┘
```

#### 表示要素
- **ヘッダー**: "FOOTBALL SCORES"
- **リロードボタン**: 右上のタッチ可能なボタン
- **期間表示**: データ取得期間
- **ステータス表示**: API通信状態
- **試合データ**: 日付、チーム名、スコア、大会名
- **フッター**: 操作方法と現在時刻

#### 勝敗表示記号
- **★**: 勝利チーム（ホーム勝利は左、アウェイ勝利は右）
- **=**: 引き分け（両チームに表示）

### 4. 操作仕様

#### 物理ボタン
- **ボタンC**: データ更新（リロード）

#### タッチ操作
- **リロードボタン**: タッチでデータ更新
- **ボタン位置**: 右上（120x40ピクセル）

#### 自動更新
- **間隔**: 30分ごと
- **条件**: WiFi接続時のみ
- **重複防止**: 更新中は新規更新をブロック

### 5. エラーハンドリング

#### WiFi接続エラー
- 接続失敗時はモックデータで動作継続
- デバッグ画面で接続状態を表示

#### API通信エラー
- HTTP 400エラー: 日付範囲エラー
- HTTP 401エラー: 認証エラー
- HTTP 429エラー: レート制限
- 通信失敗時はモックデータを使用

#### NTP時刻エラー
- 無効な年（2025年以外）は手動日付を使用
- 同期失敗時は手動設定日付で動作

### 6. データ構造

#### MatchScore構造体
```cpp
struct MatchScore {
  String homeTeam;        // ホームチーム名
  String awayTeam;        // アウェイチーム名
  int homeScore;          // ホームスコア
  int awayScore;          // アウェイスコア
  String matchDate;       // 試合日付
  String competition;     // 大会名
  bool isFinished;        // 終了フラグ
  unsigned long dateTimestamp; // ソート用タイムスタンプ
};
```

#### モックデータ
Club World Cupを含む10試合のサンプルデータを内蔵

### 7. パフォーマンス仕様

#### メモリ使用量
- **JSON解析**: 最大8KB
- **試合データ**: 最大15試合
- **デバッグ情報**: 可変長文字列

#### 通信仕様
- **タイムアウト**: 15秒
- **リトライ**: なし（単発リクエスト）
- **レート制限**: API側の制限に従う

#### 更新頻度
- **手動更新**: 即座に実行
- **自動更新**: 30分間隔
- **表示更新**: データ取得後即座に実行

### 8. デバッグ機能

#### シリアル出力
- WiFi接続状態
- API通信結果
- エラー詳細
- データ解析結果

#### デバッグ画面
- 起動時の状態表示
- 更新中の進行状況
- エラー情報の表示

### 9. 制限事項

#### API制限
- 日付範囲: 最大10日間
- リクエスト頻度: API側の制限に従う
- データ期間: 過去の試合のみ

#### ディスプレイ制限
- 表示試合数: 最大12試合（2列×6行）
- チーム名: 最大10文字（超過時は省略）
- 大会名: 最大15文字（超過時は省略）

#### ハードウェア制限
- WiFi接続必須
- 電源供給必要
- 電子ペーパーの更新速度制限

## 今後の拡張予定
- 複数大会の選択機能
- より詳細な試合情報表示
- オフライン機能の強化
- 設定画面の追加 